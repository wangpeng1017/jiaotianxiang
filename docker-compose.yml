version: '3.8'

services:
  # ==========================================
  # Middleware Services
  # ==========================================
  mysql:
    image: mysql:5.7
    container_name: jtx-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: jtx_mct
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./init_sql:/docker-entrypoint-initdb.d
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --lower_case_table_names=1

  redis:
    image: redis:6.2
    container_name: jtx-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes

  rocketmq-namesrv:
    image: apache/rocketmq:4.9.4
    container_name: jtx-rocketmq-namesrv
    restart: always
    ports:
      - "9876:9876"
    command: sh mqnamesrv

  rocketmq-broker:
    image: apache/rocketmq:4.9.4
    container_name: jtx-rocketmq-broker
    restart: always
    ports:
      - "10911:10911"
      - "10909:10909"
    environment:
      NAMESRV_ADDR: "rocketmq-namesrv:9876"
    volumes:
      - ./data/rocketmq/logs:/root/logs
      - ./data/rocketmq/store:/root/store
      - ./conf/broker.conf:/opt/rocketmq-4.9.4/conf/broker.conf
    command: sh mqbroker -n rocketmq-namesrv:9876 -c /opt/rocketmq-4.9.4/conf/broker.conf
    depends_on:
      - rocketmq-namesrv

  # ==========================================
  # Backend Services
  # ==========================================
  jtx-mct:
    build: 
      context: ./IdeaProjects/jtx_mct
      dockerfile: DockerfileProd
    container_name: jtx-mct
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_mct?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
      - ROCKETMQ_NAME_SERVER=rocketmq-namesrv:9876
    ports:
      - "8082:8082"
    depends_on:
      - mysql
      - redis
      - rocketmq-broker
    volumes:
      - ./logs/mct:/opt/hyida-mct/logs
      - ./data/mct:/opt/hyida-mct/data

  jtx-pms:
    build:
      context: ./IdeaProjects/jtx-pms
      dockerfile: DockerfileProd
    container_name: jtx-pms
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_pms?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "9096:9096"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/pms:/logs

  jtx-erp:
    build:
      context: ./IdeaProjects/jtx-erp
      dockerfile: DockerfileProd
    container_name: jtx-erp
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_erp?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "9091:9091"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/erp:/logs

  jtx-srm:
    build:
      context: ./IdeaProjects/jtx-srm
      dockerfile: DockerfileProd
    container_name: jtx-srm
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_srm?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "9092:9092"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/srm:/logs

  jtx-mdm:
    build:
      context: ./IdeaProjects/jtx-mdm
      dockerfile: DockerfileProd
    container_name: jtx-mdm
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_mdm?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "9093:9093"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/mdm:/logs

  jtx-oa:
    build:
      context: ./IdeaProjects/jtx-oa
      dockerfile: DockerfileProd
    container_name: jtx-oa
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_oa?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "9094:9094"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/oa:/logs

  jtx-sso:
    build:
      context: ./IdeaProjects/jtx-sso
      dockerfile: DockerfileProd
    container_name: jtx-sso
    restart: always
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/jtx_sso?useUnicode=true&characterEncoding=utf-8&useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs/sso:/logs

  # ==========================================
  # Frontend Gateway
  # ==========================================
  nginx:
    image: nginx:1.21
    container_name: jtx-nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./conf/nginx.conf:/etc/nginx/nginx.conf
      - ./html:/usr/share/nginx/html
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - jtx-mct
      - jtx-pms
      - jtx-erp
      - jtx-srm
      - jtx-mdm
      - jtx-oa
      - jtx-sso
